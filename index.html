<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coordinates Dialog</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/mdui@2.1.4/mdui.css">
    <script src="https://unpkg.com/mdui@2.1.4/mdui.global.js"></script>
    <style>
        .input-group {
            display: flex;
            gap: 16px; /* Material Design spacing */
            margin-bottom: 16px;
        }

        .input-group.tile-inputs mdui-text-field {
            flex: 1 1 25%; /* Four inputs, flexible width */
        }
        
        .input-group.coord-inputs {
            /* Set a minimum width for the container for the mobile breakpoint request */
            min-width: 320px; /* Common minimum mobile screen width */
            max-width: 100%;
        }

        .input-group.coord-inputs mdui-text-field {
        }

        .divider {
            height: 1px;
            background-color: var(--mdui-sys-color-outline-variant, #c2c7c5);
            margin: 20px 0;
        }

        .button-container {
            display: flex;
            justify-content: center;
            padding-top: 8px; /* Spacing above the button */
        }

        html, body {
            background-color: transparent !important;
        }
    </style>
</head>
<body>
    <mdui-snackbar id="copy-text">Copied to clipboard</mdui-snackbar>
    <div class="vanish-on-iframe">  
      <mdui-button id="open-dialog-button">Open Coordinate Dialog</mdui-button>
      <p>Copy this to get the dialog injected:</p>
      <mdui-button-icon icon="copy" id="copy-j"></mdui-button-icon>
      <!--a codeblock-->
      <code id="balls">
        const domain="https://henrysck075.github.io";
        <!--Add a fullscreen iframe that points to https://henrysck075.github.io/cursed-meteor/ with bg transparency on top but immediately hides it-->
        const iframe=document.createElement("iframe");iframe.src=domain+"/cursed-meteor/";iframe.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;border:none;z-index:9999;background-color:transparent";document.body.appendChild(iframe);
        iframe.onload=()=&gt;{
        const exploreBtn=document.querySelector("body&gt;div&gt;div.disable-pinch-zoom.relative.h-full.overflow-hidden&gt;div.absolute.right-2.top-2.z-30&gt;div&gt;div&gt;button[title=Explore]");const coordDialogBtn=exploreBtn.cloneNode();coordDialogBtn.title="C";exploreBtn.parentElement.appendChild(coordDialogBtn);
        coordDialogBtn.onclick=()=&gt;{iframe.style.display="block";iframe.contentWindow.postMessage({type:"spawn"},domain);};
        window.addEventListener("message",(e)=&gt;{
        if(e.origin!==domain)return;
        if(e.data.type=="close"){iframe.style.display="none";return;}
        const loc=JSON.parse(localStorage.getItem("location"));
        if(e.data.type=="loc"){loc.type="loc";iframe.contentWindow.postMessage(loc,domain);return;};
        for(const key in e.data){loc[key]=e.data[key];}localStorage.setItem("location",JSON.stringify(loc));location.reload();
        });
        setTimeout(()=&gt;{iframe.style.display="none";},50);
        }; 
      </code>
    </div>

    <mdui-dialog id="coordinate-dialog" close-on-overlay-click> 
      <mdui-top-app-bar slot="header" id="mobile-header">
        <mdui-button-icon icon="close" id="close"></mdui-button-icon>
      </mdui-top-app-bar>
      <div>
        <div class="input-group tile-inputs">
            <mdui-text-field variant="outlined" 
                id="tile-x" 
                label="Tile X" 
                
                value="0"
                min="0">
            </mdui-text-field>
            <mdui-text-field variant="outlined" 
                id="tile-y" 
                label="Tile Y" 
                
                value="0"
                min="0">
            </mdui-text-field>
            <mdui-text-field variant="outlined" 
                id="pixel-x" 
                label="Pixel X" 
                
                value="0"
                min="0">
            </mdui-text-field>
            <mdui-text-field variant="outlined" 
                id="pixel-y" 
                label="Pixel Y" 
                
                value="0"
                min="0">
            </mdui-text-field>
        </div>

        <div class="divider"></div>

        <div class="input-group coord-inputs">
            <mdui-text-field variant="outlined" 
                id="latitude" 
                label="Latitude" 
                
                value="0">
            </mdui-text-field>
            <mdui-text-field variant="outlined" 
                id="longitude" 
                label="Longitude" 
                
                value="0">
            </mdui-text-field>
        </div>
        <div class="visible-on-iframe">
          <mdui-button-icon icon="location_on" id="get_last_selected_location"></mdui-button-icon>
        </div>

      </div>
      <mdui-button slot="action" id="teleport-button" disabled>Teleport</mdui-button>
      <mdui-button slot="action" id="copy-button">Copy URL</mdui-button>

    </mdui-dialog>

    <script src="mercator_util.js"></script>
    <script>
        const targetOrigin = "https://wplace.live"

        const dialog = document.getElementById('coordinate-dialog');
        const openButton = document.getElementById('open-dialog-button');
        const teleportButton = document.getElementById('teleport-button');

        // The copy button will get the text content of "code#balls", deletes all /\n */ and copy the text with the "javascript:" prefix
        document.getElementById("copy-j").addEventListener("click", ()=>{
          const code = document.getElementById("balls").textContent.replace(/\n\s*/g, "");
          const finalCode = "javascript:" + code;
          navigator.clipboard.writeText(finalCode).then(()=>{
            //alert("Code copied to clipboard!");
            document.getElementById("copy-text").open = true;
          }).catch((err)=>{
            alert("Failed to copy code: " + err);
          });
        });

        const mercator = new WebMercatorProjection(1000);

        const inputs = {
            tileX: document.getElementById('tile-x'),
            tileY: document.getElementById('tile-y'),
            pixelX: document.getElementById('pixel-x'),
            pixelY: document.getElementById('pixel-y'),
            latitude: document.getElementById('latitude'),
            longitude: document.getElementById('longitude')
        };

        // Fullscreen the dialog if it hits the mobile breakpoint
        dialog.fullscreen = mdui.breakpoint().down("md")
        
        // 
        if (mdui.breakpoint().up("sm")) {
          // delete the header
          document.getElementById("mobile-header").remove();
        } else {
          // bind click to the close button to close the dialog
          document.getElementById("close").addEventListener("click", ()=>{
            dialog.open = false;
          })
        }

        document.getElementById("get_last_selected_location").onclick = ()=>{
          function nerd(e) {
            if (e.origin !== targetOrigin) return;
            if (e.data.type="loc") {
              inputs.latitude.value = e.data.lat;
              inputs.longitude.value = e.data.lng;
              window.removeEventListener("message", nerd);
              convertCoords(true);
            }
          }
          window.addEventListener("message", nerd)
          parent.postMessage({type:"loc"}, targetOrigin)
        }

        // Function to check if the page is running inside an iframe
        function isInIframe() {
            try {
                return window.self !== window.top && window.top.location.href.includes("wplace.live");
            } catch (e) {
                return true; // Assume in iframe if cross-origin access fails
            }
        }

        // Initialize button state
        teleportButton.disabled = !isInIframe();

        if (!teleportButton.disabled) {
          Array.from(document.getElementsByClassName("vanish-on-iframe")).forEach(e=>e.remove());
        } else {
          Array.from(document.getElementsByClassName("visible-on-iframe")).forEach(e=>e.remove());
        }

        // Conversion logic (simplified mock-up for demonstration)
        function convertCoords(_isCoordInput = undefined) {
          // Get current values as numbers (or 0 if empty/invalid)
          const tx = parseFloat(inputs.tileX.value) || 0;
          const ty = parseFloat(inputs.tileY.value) || 0;
          const px = parseFloat(inputs.pixelX.value) || 0;
          const py = parseFloat(inputs.pixelY.value) || 0;
          const lat = parseFloat(inputs.latitude.value) || 0;
          const lon = parseFloat(inputs.longitude.value) || 0;

          const zoom = 11;

          // Determine which set of inputs triggered the change
          const activeElement = document.activeElement;
          const isCoordInput = _isCoordInput !== undefined ? _isCoordInput : activeElement === inputs.latitude || activeElement === inputs.longitude;

          if (isCoordInput) {
            // Simple conversion logic: e.g., Lat/Lon to Tile/Pixel
            const {tile: newTile, pixel: newPixel} = mercator.latLonToTileAndPixel(lat, lon, zoom);
            // Update Tile/Pixel inputs based on Lat/Lon
            inputs.tileX.value = newTile[0].toFixed(0);
            inputs.tileY.value = newTile[1].toFixed(0);
            inputs.pixelX.value = newPixel[0].toFixed(0);
            inputs.pixelY.value = newPixel[1].toFixed(0);
          } else {
            // Simple conversion logic: e.g., Tile/Pixel to Lat/Lon
            const [newLat, newLon] = mercator.pixelsToLatLon(px+tx*1000, py+ty*1000, zoom);
            // Update Lat/Lon inputs based on Tile/Pixel
            inputs.latitude.value = newLat;
            inputs.longitude.value = newLon;
          }
        }

        // Add event listeners to all numerical inputs for live conversion
        Object.values(inputs).forEach(input => {
          input.addEventListener('input', convertCoords);
          // Initialize with default values (which are "0" as per the HTML)
          convertCoords();
        });

        // Teleport button click logic
        teleportButton.addEventListener('click', () => {
          const latitudeValue = parseFloat(inputs.latitude.value);
          const longitudeValue = parseFloat(inputs.longitude.value);

          // This is where you would "do smth with it"
          console.log(`Teleporting to Latitude: ${latitudeValue}, Longitude: ${longitudeValue}`);
          parent.postMessage({
            lat: latitudeValue,
            lng: longitudeValue
          }, targetOrigin)
          
          // Optionally close the dialog after action
          dialog.open = false;
        });

        document.getElementById("copy-button").addEventListener("click", ()=>{
          const latitudeValue = parseFloat(inputs.latitude.value);
          const longitudeValue = parseFloat(inputs.longitude.value);
          const url = `https://wplace.live/?lat=${latitudeValue}&lng=${longitudeValue}`;
          navigator.clipboard.writeText(url).then(()=>{
            //alert("URL copied to clipboard!");
            document.getElementById("copy-text").open = true;
          }).catch((err)=>{
            alert("Failed to copy URL: " + err);
          });
        });        

        window.addEventListener("message", (e)=>{
          if (e.origin !== targetOrigin) return;
          if (e.data.type="spawn") {
            dialog.open = true;
          }
        })

        dialog.addEventListener("closed", ()=>{
          parent.postMessage({type:"close"}, targetOrigin)
        })

        // Open dialog button for demonstration
        openButton.addEventListener('click', () => {
            dialog.open = true;
        });
    </script>
</body>
</html>
